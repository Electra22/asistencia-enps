<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - ENPS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .logo p {
            color: #666;
            font-size: 14px;
        }
        
        .clase-info {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        
        .clase-info h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .clase-info p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .admin-link {
            text-align: center;
            margin-top: 20px;
        }
        
        .admin-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .admin-link a:hover {
            text-decoration: underline;
        }
        
        /* Estilos para el panel de administraci√≥n */
        .admin-panel {
            display: none;
            max-width: 900px;
        }
        
        .admin-panel.active {
            display: block;
        }
        
        .student-form {
            display: none;
        }
        
        .student-form.active {
            display: block;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: monospace;
            min-height: 200px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            color: #666;
            font-size: 14px;
        }
        
        .attendance-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
        }
        
        .attendance-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .attendance-item:last-child {
            border-bottom: none;
        }
        
        .attendance-item strong {
            color: #333;
        }
        
        .attendance-item small {
            color: #666;
        }
        
        .helper-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        #qrcode {
            display: inline-block;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <!-- Formulario de Asistencia (Vista Alumno) -->
    <div class="container student-form active" id="studentForm">
        <div class="logo">
            <h1>üìö Asistencia ENPS</h1>
            <p>Evaluaci√≥n Neuropsicol√≥gica</p>
        </div>
        
        <div class="clase-info" id="claseInfo">
            <h3 id="claseTitulo">Cargando informaci√≥n de clase...</h3>
            <p id="claseFecha"></p>
        </div>
        
        <form id="asistenciaForm">
            <div class="form-group">
                <label for="dni">DNI (sin puntos ni espacios)</label>
                <input 
                    type="text" 
                    id="dni" 
                    name="dni" 
                    placeholder="12345678"
                    pattern="[0-9]{7,8}"
                    required
                    autocomplete="off"
                >
                <p class="helper-text">Ingres√° tu DNI de 7 u 8 d√≠gitos</p>
            </div>
            
            <button type="submit" id="submitBtn">
                ‚úì Registrar Asistencia
            </button>
        </form>
        
        <div class="message" id="message"></div>
        
        <div class="admin-link">
            <a href="#" id="adminToggle">Panel de Administraci√≥n</a>
        </div>
    </div>

    <!-- Panel de Administraci√≥n -->
    <div class="container admin-panel" id="adminPanel">
        <div class="logo">
            <h1>‚öôÔ∏è Panel de Administraci√≥n</h1>
            <p>Sistema de Asistencia</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="asistencias">Asistencias</button>
            <button class="tab" data-tab="alumnos">Alumnos</button>
            <button class="tab" data-tab="qr">QR Code</button>
        </div>
        
        <!-- Tab Asistencias -->
        <div class="tab-content active" id="asistencias-tab">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalAsistencias">0</h3>
                    <p>Registros totales</p>
                </div>
                <div class="stat-card">
                    <h3 id="alumnosHoy">0</h3>
                    <p>Presentes hoy</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalAlumnos">0</h3>
                    <p>Alumnos cargados</p>
                </div>
            </div>
            
            <button id="exportBtn" class="btn-success">
                üì• Descargar Excel
            </button>
            
            <div style="margin-top: 25px;">
                <h3 style="margin-bottom: 15px; color: #333;">√öltimas asistencias</h3>
                <div class="attendance-list" id="attendanceList">
                    <p style="text-align: center; color: #666;">No hay registros a√∫n</p>
                </div>
            </div>
        </div>
        
        <!-- Tab Alumnos -->
        <div class="tab-content" id="alumnos-tab">
            <h3 style="margin-bottom: 15px; color: #333;">Cargar lista de alumnos</h3>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                Ingres√° un alumno por l√≠nea en formato: <strong>DNI - Nombre Completo</strong>
            </p>
            <textarea id="alumnosTextarea" placeholder="12345678 - Juan P√©rez&#10;23456789 - Mar√≠a Gonz√°lez&#10;34567890 - Carlos L√≥pez"></textarea>
            <div class="helper-text">Ejemplo: 12345678 - Juan P√©rez</div>
            
            <div class="button-group">
                <button id="saveAlumnosBtn" class="btn-success">üíæ Guardar Alumnos</button>
                <button id="clearAlumnosBtn" class="btn-secondary">üóëÔ∏è Limpiar Todo</button>
            </div>
            
            <div class="message" id="alumnosMessage"></div>
        </div>
        
        <!-- Tab QR -->
        <div class="tab-content" id="qr-tab">
            <h3 style="margin-bottom: 15px; color: #333; text-align: center;">C√≥digo QR para escanear</h3>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px; text-align: center;">
                Mostr√° este QR en clase para que los alumnos registren su asistencia
            </p>
            <div class="qr-container">
                <div id="qrcode"></div>
                <button id="downloadQRBtn" class="btn-success">üì• Descargar QR</button>
            </div>
        </div>
        
        <div class="admin-link">
            <a href="#" id="backToForm">‚Üê Volver al formulario</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // Cronograma de clases
        const cronograma = [
            { fecha: '2026-03-05', numero: 1, tema: 'Introducci√≥n a la materia: Introducci√≥n a la ENPS, Bater√≠a fijas vs flexibles' },
            { fecha: '2026-03-12', numero: 2, tema: 'Anamnesis + Observaci√≥n conductual' },
            { fecha: '2026-03-19', numero: 3, tema: 'Test de Screening' },
            { fecha: '2026-03-26', numero: 4, tema: 'Inteligencia prem√≥rbida + medidas de d√©ficits - Puntaje Z, Escalar, Est√°ndar, Puntaje T' },
            { fecha: '2026-04-09', numero: 5, tema: 'Inteligencia actual e introducci√≥n al WAIS IV' },
            { fecha: '2026-04-16', numero: 6, tema: 'WAIS IV (Administraci√≥n)' },
            { fecha: '2026-04-23', numero: 7, tema: 'Funciones Estado: Nivel de alerta y Atenci√≥n' },
            { fecha: '2026-04-30', numero: 8, tema: 'Funciones Estado II: Funciones Ejecutivas y Cognici√≥n Social' },
            { fecha: '2026-05-07', numero: 9, tema: 'Memoria' },
            { fecha: '2026-05-14', numero: 10, tema: 'Lenguaje' },
            { fecha: '2026-05-21', numero: 11, tema: 'Gnosias y Praxias' },
            { fecha: '2026-05-28', numero: 12, tema: 'Repaso Parcial' },
            { fecha: '2026-08-06', numero: 13, tema: 'La redacci√≥n del informe neuropsicol√≥gico' },
            { fecha: '2026-08-13', numero: 14, tema: 'ENPS en Personas con Bajo Nivel Educacional y en el Adulto Joven' },
            { fecha: '2026-08-20', numero: 15, tema: 'La ENPS en las principales Enfermedades Neurol√≥gicas I (DCL)' },
            { fecha: '2026-08-27', numero: 16, tema: 'La ENPS en las principales Enfermedades Neurol√≥gicas II (Demencias corticales)' },
            { fecha: '2026-09-03', numero: 17, tema: 'La ENPS en las principales Enfermedades Neurol√≥gicas IV (TEC- ACV- Tumores- mano ajena)' },
            { fecha: '2026-09-10', numero: 18, tema: 'La ENPS en las principales Enfermedades Neurol√≥gicas III (Trastornos del movimiento)' },
            { fecha: '2026-09-17', numero: 19, tema: 'La ENPS en las principales Enfermedades Neurol√≥gicas V (Epilepsia y EM)' },
            { fecha: '2026-09-24', numero: 20, tema: 'La ENPS en las principales Enfermedades Neuropsiqui√°tricas I (Depresi√≥n y Esquizofrenia-TB)' },
            { fecha: '2026-10-01', numero: 21, tema: 'La ENPS en las principales Enfermedades Neuropsiqui√°tricas II (ADHD- Adicciones)' },
            { fecha: '2026-10-08', numero: 22, tema: 'La ENPS en las principales Enfermedades Neuropsiqui√°tricas III (Trastornos de la cognici√≥n social- Asperger)' },
            { fecha: '2026-10-15', numero: 23, tema: 'ENPS Online y simulaci√≥n' }
        ];

        // Storage keys
        const STORAGE_KEYS = {
            alumnos: 'enps_alumnos',
            asistencias: 'enps_asistencias'
        };

        // Inicializaci√≥n
        let alumnos = JSON.parse(localStorage.getItem(STORAGE_KEYS.alumnos) || '[]');
        let asistencias = JSON.parse(localStorage.getItem(STORAGE_KEYS.asistencias) || '[]');

        // Funciones de utilidad
        function guardarAlumnos() {
            localStorage.setItem(STORAGE_KEYS.alumnos, JSON.stringify(alumnos));
        }

        function guardarAsistencias() {
            localStorage.setItem(STORAGE_KEYS.asistencias, JSON.stringify(asistencias));
        }

        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-AR', opciones);
        }

        function obtenerClaseActual() {
            const hoy = new Date().toISOString().split('T')[0];
            return cronograma.find(clase => clase.fecha === hoy) || cronograma[0];
        }

        function mostrarMensaje(elemento, texto, tipo) {
            elemento.textContent = texto;
            elemento.className = `message ${tipo} show`;
            setTimeout(() => {
                elemento.classList.remove('show');
            }, 5000);
        }

        // Actualizar informaci√≥n de clase
        function actualizarInfoClase() {
            const claseActual = obtenerClaseActual();
            document.getElementById('claseTitulo').textContent = `Clase ${claseActual.numero}: ${claseActual.tema}`;
            document.getElementById('claseFecha').textContent = formatearFecha(claseActual.fecha);
        }

        // Formulario de asistencia
        document.getElementById('asistenciaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dni = document.getElementById('dni').value.trim();
            const mensaje = document.getElementById('message');
            const submitBtn = document.getElementById('submitBtn');
            
            // Validar DNI
            if (!/^\d{7,8}$/.test(dni)) {
                mostrarMensaje(mensaje, '‚ùå El DNI debe tener 7 u 8 d√≠gitos', 'error');
                return;
            }
            
            // Verificar si el alumno est√° en la lista
            const alumno = alumnos.find(a => a.dni === dni);
            
            if (alumnos.length > 0 && !alumno) {
                mostrarMensaje(mensaje, '‚ùå DNI no registrado. Consult√° con el docente.', 'error');
                return;
            }
            
            // Verificar asistencia duplicada hoy
            const hoy = new Date().toISOString().split('T')[0];
            const yaRegistrado = asistencias.some(a => 
                a.dni === dni && a.fecha.startsWith(hoy)
            );
            
            if (yaRegistrado) {
                mostrarMensaje(mensaje, '‚ö†Ô∏è Ya registraste tu asistencia hoy', 'error');
                return;
            }
            
            // Registrar asistencia
            const claseActual = obtenerClaseActual();
            const registro = {
                dni: dni,
                nombre: alumno ? alumno.nombre : 'Alumno no identificado',
                fecha: new Date().toISOString(),
                clase: claseActual.numero,
                tema: claseActual.tema
            };
            
            asistencias.unshift(registro);
            guardarAsistencias();
            
            // Mostrar √©xito
            const nombreMostrar = alumno ? alumno.nombre : dni;
            mostrarMensaje(mensaje, `‚úÖ ¬°Asistencia registrada! Bienvenido/a ${nombreMostrar}`, 'success');
            
            // Limpiar formulario
            document.getElementById('dni').value = '';
            
            // Actualizar stats si el panel est√° abierto
            if (document.getElementById('adminPanel').classList.contains('active')) {
                actualizarEstadisticas();
                actualizarListaAsistencias();
            }
        });

        // Panel de administraci√≥n - Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // Toggle admin panel
        document.getElementById('adminToggle').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('studentForm').classList.remove('active');
            document.getElementById('adminPanel').classList.add('active');
            actualizarEstadisticas();
            actualizarListaAsistencias();
            generarQR();
        });

        document.getElementById('backToForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('studentForm').classList.add('active');
        });

        // Guardar alumnos
        document.getElementById('saveAlumnosBtn').addEventListener('click', function() {
            const texto = document.getElementById('alumnosTextarea').value;
            const lineas = texto.split('\n').filter(l => l.trim());
            
            const nuevosAlumnos = [];
            const errores = [];
            
            lineas.forEach((linea, index) => {
                const match = linea.match(/^(\d{7,8})\s*-\s*(.+)$/);
                if (match) {
                    nuevosAlumnos.push({
                        dni: match[1].trim(),
                        nombre: match[2].trim()
                    });
                } else {
                    errores.push(`L√≠nea ${index + 1}: formato incorrecto`);
                }
            });
            
            if (errores.length > 0) {
                mostrarMensaje(
                    document.getElementById('alumnosMessage'),
                    '‚ùå Errores encontrados:\n' + errores.join('\n'),
                    'error'
                );
                return;
            }
            
            alumnos = nuevosAlumnos;
            guardarAlumnos();
            actualizarEstadisticas();
            
            mostrarMensaje(
                document.getElementById('alumnosMessage'),
                `‚úÖ ${alumnos.length} alumnos guardados correctamente`,
                'success'
            );
        });

        // Limpiar alumnos
        document.getElementById('clearAlumnosBtn').addEventListener('click', function() {
            if (confirm('¬øEst√°s seguro de que quer√©s eliminar todos los alumnos?')) {
                alumnos = [];
                guardarAlumnos();
                document.getElementById('alumnosTextarea').value = '';
                actualizarEstadisticas();
                mostrarMensaje(
                    document.getElementById('alumnosMessage'),
                    '‚úÖ Lista de alumnos eliminada',
                    'success'
                );
            }
        });

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            document.getElementById('totalAsistencias').textContent = asistencias.length;
            document.getElementById('totalAlumnos').textContent = alumnos.length;
            
            const hoy = new Date().toISOString().split('T')[0];
            const asistenciasHoy = asistencias.filter(a => a.fecha.startsWith(hoy));
            document.getElementById('alumnosHoy').textContent = asistenciasHoy.length;
        }

        // Actualizar lista de asistencias
        function actualizarListaAsistencias() {
            const lista = document.getElementById('attendanceList');
            
            if (asistencias.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #666;">No hay registros a√∫n</p>';
                return;
            }
            
            lista.innerHTML = asistencias.slice(0, 50).map(a => {
                const fecha = new Date(a.fecha);
                const fechaStr = fecha.toLocaleDateString('es-AR');
                const horaStr = fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="attendance-item">
                        <div>
                            <strong>${a.nombre}</strong><br>
                            <small>DNI: ${a.dni} | Clase ${a.clase}</small>
                        </div>
                        <div style="text-align: right;">
                            <small>${fechaStr}<br>${horaStr}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Exportar a Excel
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (asistencias.length === 0) {
                alert('No hay asistencias para exportar');
                return;
            }
            
            const datos = asistencias.map(a => ({
                'DNI': a.dni,
                'Nombre': a.nombre,
                'Fecha': new Date(a.fecha).toLocaleDateString('es-AR'),
                'Hora': new Date(a.fecha).toLocaleTimeString('es-AR'),
                'Clase': a.clase,
                'Tema': a.tema
            }));
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Asistencias');
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `asistencias_enps_${fecha}.xlsx`);
        });

        // Generar QR
        let qrCode = null;
        function generarQR() {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            const url = window.location.href.split('#')[0];
            
            qrCode = new QRCode(qrContainer, {
                text: url,
                width: 300,
                height: 300,
                colorDark: '#667eea',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Descargar QR
        document.getElementById('downloadQRBtn').addEventListener('click', function() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'qr_asistencia_enps.png';
                link.href = url;
                link.click();
            }
        });

        // Cargar alumnos existentes en textarea
        if (alumnos.length > 0) {
            document.getElementById('alumnosTextarea').value = 
                alumnos.map(a => `${a.dni} - ${a.nombre}`).join('\n');
        }

        // Inicializar
        actualizarInfoClase();
        actualizarEstadisticas();
    </script>
</body>
</html>
